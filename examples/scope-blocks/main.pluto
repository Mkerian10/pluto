// Scope blocks: scoped dependency injection for request-level state
//
// Scoped classes live for the duration of a scope block, not the entire program.
// They're perfect for per-request context, transactions, and similar patterns.

// A singleton service — lives for the entire program
class Database {
    fn query(self, q: string) string {
        return q
    }
}

// Scoped classes — created fresh for each scope block
scoped class RequestCtx {
    request_id: string
    user_id: int

    fn get_request_id(self) string {
        return self.request_id
    }

    fn get_user_id(self) int {
        return self.user_id
    }
}

// Scoped class that depends on other scoped + singleton deps
// All injected via bracket deps — auto-created inside scope blocks
scoped class UserService[db: Database, ctx: RequestCtx] {
    fn get_user(self) string {
        return self.db.query(self.ctx.get_request_id())
    }

    fn get_user_id(self) int {
        return self.ctx.get_user_id()
    }
}

// Chain of scoped deps: Handler -> UserService -> RequestCtx + Database
scoped class Handler[svc: UserService, ctx: RequestCtx] {
    fn handle(self) string {
        return self.svc.get_user()
    }

    fn request_id(self) string {
        return self.ctx.get_request_id()
    }
}

app MyApp[db: Database] {
    fn main(self) {
        // Basic scope block: seed a RequestCtx, bind a UserService
        print("--- Basic scope block ---")
        scope(RequestCtx { request_id: "req-001", user_id: 42 }) |svc: UserService| {
            print(svc.get_user())
            print(svc.get_user_id())
        }

        // Multiple bindings from a single seed
        print("--- Multiple bindings ---")
        scope(RequestCtx { request_id: "req-002", user_id: 7 }) |svc: UserService, ctx: RequestCtx| {
            print(svc.get_user())
            print(ctx.get_user_id())
        }

        // Deep dependency chain: Handler -> UserService -> RequestCtx
        print("--- Dependency chain ---")
        scope(RequestCtx { request_id: "req-003", user_id: 99 }) |h: Handler| {
            print(h.handle())
            print(h.request_id())
        }

        // Each scope block creates fresh instances
        print("--- Separate scopes ---")
        scope(RequestCtx { request_id: "first", user_id: 1 }) |svc: UserService| {
            print(svc.get_user())
        }
        scope(RequestCtx { request_id: "second", user_id: 2 }) |svc: UserService| {
            print(svc.get_user())
        }
    }
}
